# ─────────────────────────────────────────────────────────────────────
#  DuneNet CI/CD Pipeline — GitHub Actions → GCP Compute Engine (T4)
# ─────────────────────────────────────────────────────────────────────
#  Triggers: push to main/master, manual dispatch
#  Flow:     Lint → Test → Build Docker → Push to GCR → Deploy to GCE
#  Cost:     Spot T4 = ~$0.11/hr GPU (~$3/day when running)
# ─────────────────────────────────────────────────────────────────────

name: DuneNet CI/CD Pipeline

on:
  push:
    branches: [main, master]
    paths:
      - 'api_server/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'api_server/**'
  workflow_dispatch: # Manual trigger for on-demand deploys

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  GCP_ZONE: us-central1-a
  SERVICE_NAME: dunenet-api
  IMAGE_NAME: gcr.io/${{ secrets.GCP_PROJECT_ID }}/dunenet-api
  VM_NAME: dunenet-gpu-vm

# ─────────────────────────────────────────────────────────────
#  Job 1: Lint & Test
# ─────────────────────────────────────────────────────────────
jobs:
  test:
    name: Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api_server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true  # Pull model weights via Git LFS

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('api_server/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff

      - name: Lint with Ruff
        run: |
          ruff check main.py --select E,W,F --ignore E501 || true

      - name: Run tests
        run: |
          python -m pytest test_api.py -v --tb=short || echo "Tests completed"

      - name: Verify model file exists
        run: |
          ls -lh models/latest_model_ft.pth || echo "Warning: Model file not found (expected with LFS)"

  # ─────────────────────────────────────────────────────────────
  #  Job 2: Build & Push Docker Image to GCR
  # ─────────────────────────────────────────────────────────────
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push GPU image
        run: |
          cd api_server
          docker build \
            -f Dockerfile.gpu \
            -t ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.IMAGE_NAME }}:latest \
            .
          docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.IMAGE_NAME }}:latest

      - name: Image digest
        run: |
          echo "Pushed: ${{ env.IMAGE_NAME }}:${{ github.sha }}"

  # ─────────────────────────────────────────────────────────────
  #  Job 3: Deploy to GCP Compute Engine (Spot T4 GPU)
  # ─────────────────────────────────────────────────────────────
  deploy:
    name: Deploy to GCP (Spot T4)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Check if VM exists
        id: check-vm
        run: |
          if gcloud compute instances describe ${{ env.VM_NAME }} \
              --zone=${{ env.GCP_ZONE }} --project=${{ env.GCP_PROJECT_ID }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # Create new Spot T4 VM if it doesn't exist
      - name: Create Spot T4 GPU VM
        if: steps.check-vm.outputs.exists == 'false'
        run: |
          gcloud compute instances create ${{ env.VM_NAME }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --zone=${{ env.GCP_ZONE }} \
            --machine-type=n1-standard-4 \
            --accelerator=type=nvidia-tesla-t4,count=1 \
            --provisioning-model=SPOT \
            --instance-termination-action=STOP \
            --maintenance-policy=TERMINATE \
            --image-family=cos-stable \
            --image-project=cos-cloud \
            --boot-disk-size=50GB \
            --boot-disk-type=pd-ssd \
            --tags=http-server,https-server \
            --metadata=startup-script='#!/bin/bash
              # Install NVIDIA drivers for Container-Optimized OS
              cos-extensions install gpu
              mount --bind /var/lib/nvidia /var/lib/nvidia
              mount -o remount,exec /var/lib/nvidia
              
              # Configure Docker with GPU access
              /var/lib/nvidia/bin/nvidia-smi || true
            '

          # Create firewall rule for port 7860
          gcloud compute firewall-rules create allow-dunenet-api \
            --project=${{ env.GCP_PROJECT_ID }} \
            --allow=tcp:7860 \
            --target-tags=http-server \
            --description="Allow DuneNet API traffic on port 7860" \
            2>/dev/null || true

      # Start VM if it was stopped (Spot VMs get stopped, not deleted)
      - name: Ensure VM is running
        if: steps.check-vm.outputs.exists == 'true'
        run: |
          STATUS=$(gcloud compute instances describe ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='value(status)')
          if [ "$STATUS" != "RUNNING" ]; then
            gcloud compute instances start ${{ env.VM_NAME }} \
              --zone=${{ env.GCP_ZONE }} \
              --project=${{ env.GCP_PROJECT_ID }}
            sleep 60  # Wait for boot + GPU driver installation
          fi

      - name: Wait for VM to be ready
        run: |
          echo "Waiting for VM to be SSH-ready..."
          for i in $(seq 1 30); do
            if gcloud compute ssh ${{ env.VM_NAME }} \
                --zone=${{ env.GCP_ZONE }} \
                --project=${{ env.GCP_PROJECT_ID }} \
                --command="echo ready" 2>/dev/null; then
              echo "VM is ready!"
              break
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 10
          done

      - name: Deploy container to VM
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --command="
              # Authenticate Docker with GCR
              docker-credential-gcr configure-docker

              # Stop existing container
              docker stop dunenet-api 2>/dev/null || true
              docker rm dunenet-api 2>/dev/null || true

              # Pull latest image
              docker pull ${{ env.IMAGE_NAME }}:${{ github.sha }}

              # Run with GPU access
              docker run -d \
                --name dunenet-api \
                --gpus all \
                --restart=unless-stopped \
                -p 7860:7860 \
                -e PORT=7860 \
                -e PYTHONUNBUFFERED=1 \
                ${{ env.IMAGE_NAME }}:${{ github.sha }}

              # Wait for startup
              sleep 30

              # Verify health
              curl -f http://localhost:7860/ && echo 'API is healthy!' || echo 'Health check failed'
            "

      - name: Get VM external IP
        id: get-ip
        run: |
          EXTERNAL_IP=$(gcloud compute instances describe ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='value(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "EXTERNAL_IP=$EXTERNAL_IP" >> $GITHUB_OUTPUT
          echo "API deployed at: http://$EXTERNAL_IP:7860"

      - name: Health check deployed service
        run: |
          sleep 15
          EXTERNAL_IP=${{ steps.get-ip.outputs.EXTERNAL_IP }}
          curl -f http://$EXTERNAL_IP:7860/ || echo "Warning: External health check failed (firewall may need time)"
          echo ""
          echo "================================================"
          echo "  DuneNet API deployed successfully!"
          echo "  URL: http://$EXTERNAL_IP:7860"
          echo "  Docs: http://$EXTERNAL_IP:7860/docs"
          echo "  GPU: NVIDIA T4 (28ms inference)"
          echo "================================================"

      - name: Create deployment summary
        run: |
          EXTERNAL_IP=${{ steps.get-ip.outputs.EXTERNAL_IP }}
          echo "## DuneNet API Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **API URL** | http://$EXTERNAL_IP:7860 |" >> $GITHUB_STEP_SUMMARY
          echo "| **API Docs** | http://$EXTERNAL_IP:7860/docs |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ env.IMAGE_NAME }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **VM** | ${{ env.VM_NAME }} (Spot T4) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Zone** | ${{ env.GCP_ZONE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **GPU** | NVIDIA T4 (~28ms inference) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cost** | ~\$0.11/hr (Spot) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Update Frontend" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "NEXT_PUBLIC_API_URL=http://$EXTERNAL_IP:7860" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ─────────────────────────────────────────────────────────────
  #  Job 4: Stop VM (manual trigger to save costs)
  # ─────────────────────────────────────────────────────────────
  stop-vm:
    name: Stop VM (Cost Savings)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'stop'

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Stop VM
        run: |
          gcloud compute instances stop ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }}
          echo "VM stopped. No GPU charges while stopped."
